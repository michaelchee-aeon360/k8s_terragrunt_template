name: Terragrunt Plan

on:
  pull_request:
    branches: [main]
    paths:
      - "terragrunt/**"

jobs:
  format-validate-plan:
    name: Format, Validate, and Plan
    runs-on: ubuntu-latest
    container:
      image: alpine/terragrunt:1.14.1
    defaults:
      run:
        working-directory: ./terragrunt/environments
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Terraform formatting
        working-directory: ./terragrunt  # terraform files may be in root of terragrunt dir
        run: |
          echo "ğŸ” Checking Terraform code formatting..."
          if terraform fmt --recursive --check --diff; then
            echo "âœ… Terraform formatting check passed!"
          else
            echo ""
            echo "âŒ Terraform files are not properly formatted."
            echo "ğŸ‘‰ Please run the following command locally and commit the changes:"
            echo ""
            echo "   terraform fmt --recursive"
            echo ""
            exit 1
          fi

      - name: Check Terragrunt HCL formatting
        run: |
          echo "ğŸ” Checking Terragrunt HCL formatting..."
          if terragrunt hcl fmt --check; then
            echo "âœ… Terragrunt HCL formatting check passed!"
          else
            echo ""
            echo "âŒ Terragrunt .hcl files are not properly formatted."
            echo "ğŸ‘‰ Please run the following command locally and commit the changes:"
            echo ""
            echo "   terragrunt hcl fmt"
            echo ""
            exit 1
          fi
      # - name: Terragrunt validate
      #   run: terragrunt run --all validate

      # - name: Terragrunt plan
      #   run: terragrunt run --all plan
