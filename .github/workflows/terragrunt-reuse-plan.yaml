name: Reusable Terragrunt Format Check

on:
  workflow_call:
    inputs:
      run_type:
        description: 'The pipeline run type, either merge or main'
        required: false
        type: string
        default: merge

jobs:
  format-validation-plan:
    name: Check Terraform & Terragrunt Formatting
    runs-on: ubuntu-latest
    container:
      image: devopsinfra/docker-terragrunt:tf-1.14.3-tg-0.97.2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Terraform formatting
        run: |
          echo "ğŸ” Checking Terraform code formatting..."
          if terraform fmt --recursive --check; then
            echo "âœ… Terraform formatting check passed!"
          else
            echo ""
            echo "âŒ Terraform files are not properly formatted."
            echo "ğŸ‘‰ Please run the following command locally and commit the changes:"
            echo ""
            echo "   terraform fmt --recursive"
            echo ""
            exit 1
          fi

      - name: Check Terragrunt HCL formatting
        run: |
          echo "ğŸ” Checking Terragrunt HCL formatting..."
          if terragrunt hcl fmt --check; then
            echo "âœ… Terragrunt HCL formatting check passed!"
          else
            echo ""
            echo "âŒ Terragrunt .hcl files are not properly formatted."
            echo "ğŸ‘‰ Please run the following command locally and commit the changes:"
            echo ""
            echo "   terragrunt hcl fmt"
            echo ""
            exit 1
          fi
      
      # - name: Terragrunt validate
      #   run: terragrunt run --all validate
      - name: Fix dubious ownership
        run: git config --global --add safe.directory '*'

      - name: Terragrunt plan
        run: terragrunt run --all --filter '[main...HEAD]' plan