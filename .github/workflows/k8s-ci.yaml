name: Validate Kubernetes Manifests
on:
  pull_request:
    branches:
      - main
    paths:
      - k8s/apps/**
jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: alpine/k8s:1.32.11 # includes kubectl, helm, yq, git, bash
    steps:
      - name: Checkout code (current PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for full history & base branch comparison
      - name: Set up variables
        id: vars
        run: |
          echo "base_ref=${{ github.base_ref }}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
      - name: Validate YAML formatting and app names
        shell: bash
        run: "set -e\n\nK8S_APPS_ROOT=\"k8s/apps\"\n\n# --- 1. YAML Formatting Check ---\necho \"\U0001F50D Checking YAML formatting...\"\nformatted_files=()\nwhile IFS= read -r -d '' file; do\n  if ! yq eval '.' \"$file\" > /tmp/formatted.yaml 2>/dev/null; then\n    echo \"‚ùå Invalid YAML syntax in $file\"\n    exit 1\n  fi\n  if ! cmp -s \"$file\" /tmp/formatted.yaml; then\n    formatted_files+=(\"$file\")\n  fi\ndone < <(find . -path \"./$K8S_APPS_ROOT/*/*/*.yaml\" -print0 2>/dev/null || true)\n\nif [ ${#formatted_files[@]} -gt 0 ]; then\n  echo \"‚ùå The following files need reformatting:\"\n  printf '  %s\\n' \"${formatted_files[@]}\"\n  echo \"\"\n  echo \"\U0001F4A1 Fix with: yq eval '.' -i <file>\"\n  exit 1\nelse\n  echo \"‚úÖ All YAML files are correctly formatted.\"\nfi\n\n# --- 2. App Name Validation ---\necho \"\U0001F50D Validating app name format...\"\nwhile IFS= read -r -d '' app_dir; do\n  app_name=$(basename \"$app_dir\")\n  if [[ ! \"$app_name\" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then\n    echo \"‚ùå Invalid app name: '$app_name'\"\n    echo \"   ‚Üí Must contain only lowercase letters, digits, and dashes (e.g., my-app-v1).\"\n    exit 1\n  fi\ndone < <(find \"./$K8S_APPS_ROOT\" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null || true)\n\necho \"‚úÖ All app names are valid.\"\n"
      - name: Detect changed environment folders
        id: changed_envs
        run: |
          set -e
          BASE_REF="${{ github.base_ref }}"
          echo "Comparing against base branch: $BASE_REF"

          # üëá Fix: Mark workspace as safe for git
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          # Fetch base ref
          git fetch origin "$BASE_REF":base_branch

          # Find changed env dirs
          CHANGED_ENV_DIRS=$(git diff --name-only base_branch HEAD | \
            grep -E '^k8s/apps/[^/]+/(dev|staging|prod|dr)/' | \
            sed -E 's|^([^/]+/[^/]+/[^/]+/[^/]+).*|\1|' | sort -u)

          if [ -z "$CHANGED_ENV_DIRS" ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No environment folders changed."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_dirs<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CHANGED_ENV_DIRS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Run kustomize diff for changed environments
        if: steps.changed_envs.outputs.no_changes == 'false'
        run: "set -e\nBASE_REF=\"${{ github.base_ref }}\"\nCHANGED_DIRS=\"${{ steps.changed_envs.outputs.changed_dirs }}\"\n\necho \"\U0001F504 Detected changed environments:\"\necho \"$CHANGED_DIRS\"\n\nHAS_DIFF=false\nwhile IFS= read -r env_dir; do\n  [ -z \"$env_dir\" ] && continue\n  kust_file=\"$env_dir/kustomization.yaml\"\n  if [ ! -f \"$kust_file\" ]; then\n    echo \"‚ö†Ô∏è Skipping $env_dir (no kustomization.yaml)\"\n    continue\n  fi\n\n  echo \"\U0001F4C4 Processing $env_dir...\"\n\n  # Render current (HEAD)\n  kubectl kustomize \"$env_dir\" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/current.yaml\n\n  # Render base branch\n  git checkout base_branch --quiet\n  kubectl kustomize \"$env_dir\" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/base.yaml\n  git checkout -f HEAD --quiet\n\n  if ! diff -u /tmp/base.yaml /tmp/current.yaml > /tmp/diff.txt; then\n    echo \"\U0001F536 DIFF in $env_dir:\"\n    cat /tmp/diff.txt\n    HAS_DIFF=true\n  else\n    echo \"‚úÖ No diff in $env_dir\"\n  fi\ndone <<< \"$CHANGED_DIRS\"\n\nif [ \"$HAS_DIFF\" = true ]; then\n  echo \"‚ö†Ô∏è One or more environments have rendered manifest changes.\"\n  echo \"Review the diffs above to ensure they are intentional.\"\n  # Note: We don't fail here‚Äîjust inform. Change to 'exit 1' if you want to block merges.\nfi"
