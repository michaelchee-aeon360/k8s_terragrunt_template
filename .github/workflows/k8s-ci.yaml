name: Validate Kubernetes Manifests

on:
  pull_request:
    branches:
      - main
    paths:
      - 'k8s/apps/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: alpine/k8s:1.31.7  # includes kubectl, helm, yq, git, bash

    steps:
      - name: Checkout code (current PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for full history & base branch comparison

      - name: Set up variables
        id: vars
        run: |
          echo "base_ref=${{ github.base_ref }}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"

      - name: Validate YAML formatting and app names
        shell: bash
        run: |
          set -e
          K8S_APPS_ROOT="k8s/apps"

          # 1. YAML Formatting Check
          echo "üîç Checking YAML formatting..."
          formatted_files=()
          while IFS= read -r -d '' file; do
            if ! yq eval '.' "$file" > /tmp/formatted.yaml 2>/dev/null; then
              echo "‚ùå Invalid YAML syntax in $file"
              exit 1
            fi
            if ! cmp -s "$file" /tmp/formatted.yaml; then
              formatted_files+=("$file")
            fi
          done < <(find . -path "./$K8S_APPS_ROOT/*/*/*.yaml" -print0 2>/dev/null || true)

          if [ ${#formatted_files[@]} -gt 0 ]; then
            echo "‚ùå The following files need reformatting:"
            printf '  %s\n' "${formatted_files[@]}"
            echo ""
            echo "üí° Fix with: yq eval '.' -i <file>"
            exit 1
          else
            echo "‚úÖ All YAML files are correctly formatted."
          fi

          # 2. App Name Validation
          echo "üîç Validating app name format..."
          while IFS= read -r -d '' app_dir; do
            app_name=$(basename "$app_dir")
            if [[ ! "$app_name" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
              echo "‚ùå Invalid app name: '$app_name'"
              echo "   ‚Üí Must contain only lowercase letters, digits, and dashes (e.g., my-app-v1)."
              exit 1
            fi
          done < <(find "./$K8S_APPS_ROOT" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null || true)

          echo "‚úÖ All app names are valid."

      - name: Detect changed environment folders
        id: changed_envs
        shell: bash
        run: |
          set -e
          BASE_REF="${{ github.base_ref }}"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch origin "$BASE_REF":base_branch

          # Get list of all changed files in the PR
          CHANGED_FILES=$(git diff --name-only base_branch HEAD)

          # 1. Directly changed env dirs (existing logic)
          DIRECT_ENV_DIRS=$(echo "$CHANGED_FILES" | \
            grep -E '^k8s/apps/[^/]+/(dev|staging|prod|dr)/' | \
            sed -E 's|^([^/]+/[^/]+/[^/]+/[^/]+).*|\1|' | sort -u)

          # 2. Apps whose 'base/' changed
          APPS_WITH_BASE_CHANGED=$(echo "$CHANGED_FILES" | \
            grep -E '^k8s/apps/[^/]+/base/' | \
            sed -E 's|^k8s/apps/([^/]+)/base/.*|\1|' | sort -u)

          # For each such app, add all its valid env dirs (that have kustomization.yaml)
          INDIRECT_ENV_DIRS=()
          while IFS= read -r app; do
            if [ -n "$app" ]; then
              for env in dev staging prod dr; do
                env_path="k8s/apps/$app/$env"
                if [ -f "$env_path/kustomization.yaml" ]; then
                  INDIRECT_ENV_DIRS+=("$env_path")
                fi
              done
            fi
          done <<< "$APPS_WITH_BASE_CHANGED"

          # Combine and deduplicate
          ALL_CANDIDATE_DIRS=$(printf '%s\n' "${DIRECT_ENV_DIRS[@]}" "${INDIRECT_ENV_DIRS[@]}" | sort -u)

          # Validate existence of kustomization.yaml
          VALID_DIRS=()
          while IFS= read -r dir; do
            if [ -n "$dir" ] && [ -f "$dir/kustomization.yaml" ]; then
              VALID_DIRS+=("$dir")
            fi
          done <<< "$ALL_CANDIDATE_DIRS"

          if [ ${#VALID_DIRS[@]} -eq 0 ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No relevant environment folders changed (directly or via base)."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_dirs<<EOF" >> "$GITHUB_OUTPUT"
            printf '%s\n' "${VALID_DIRS[@]}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi
      - name: Run kustomize diff for changed environments
        if: steps.changed_envs.outputs.no_changes == 'false'
        shell: bash
        run: |
          set -euo pipefail
          CHANGED_DIRS="${{ steps.changed_envs.outputs.changed_dirs }}"
          BASE_BRANCH="${{ github.base_ref }}"

          echo "üîÑ Detected changed environments:"
          echo "$CHANGED_DIRS"

          HAS_DIFF=false
          while IFS= read -r env_dir; do
            [ -z "$env_dir" ] && continue
            echo "::group::üìÑ Kustomize diff for $env_dir"

            # Render current manifests
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/current.yaml

            # Render base branch manifests
            git checkout "origin/$BASE_BRANCH" --quiet
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/base.yaml
            git checkout - --quiet

            # Show clean diff
            if diff -u /tmp/base.yaml /tmp/current.yaml | sed -E '/^(---|\+\+\+|@@)/d; s/^-/‚ùå -/; s/^\+/‚úÖ +/'; then
              echo "‚úÖ No diff in $env_dir"
            else
              echo "::warning title=Kustomize Diff::$env_dir has rendered manifest changes"
              HAS_DIFF=true
            fi

            echo "::endgroup::"
          done <<< "$CHANGED_DIRS"

          if [ "$HAS_DIFF" = true ]; then
            echo "‚ö†Ô∏è One or more environments have rendered manifest changes."
          fi