name: Validate Kubernetes Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - 'k8s/apps/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: alpine/k8s:1.32.11  # includes kubectl, helm, yq, git, bash
    steps:
      - name: Checkout code (current PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for full history & base branch comparison

      - name: Set up variables
        id: vars
        run: |
          echo "base_ref=${{ github.base_ref }}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"

      - name: Validate YAML formatting and app names
        run: |
          set -e

          K8S_APPS_ROOT="k8s/apps"

          # --- 1. YAML Formatting Check ---
          echo "üîç Checking YAML formatting..."
          formatted_files=()
          while IFS= read -r -d '' file; do
            if ! yq eval '.' "$file" > /tmp/formatted.yaml 2>/dev/null; then
              echo "‚ùå Invalid YAML syntax in $file"
              exit 1
            fi
            if ! cmp -s "$file" /tmp/formatted.yaml; then
              formatted_files+=("$file")
            fi
          done < <(find . -path "./$K8S_APPS_ROOT/*/*/*.yaml" -print0 2>/dev/null || true)

          if [ ${#formatted_files[@]} -gt 0 ]; then
            echo "‚ùå The following files need reformatting:"
            printf '  %s\n' "${formatted_files[@]}"
            echo ""
            echo "üí° Fix with: yq eval '.' -i <file>"
            exit 1
          else
            echo "‚úÖ All YAML files are correctly formatted."
          fi

          # --- 2. App Name Validation ---
          echo "üîç Validating app name format..."
          while IFS= read -r -d '' app_dir; do
            app_name=$(basename "$app_dir")
            if [[ ! "$app_name" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
              echo "‚ùå Invalid app name: '$app_name'"
              echo "   ‚Üí Must contain only lowercase letters, digits, and dashes (e.g., my-app-v1)."
              exit 1
            fi
          done < <(find "./$K8S_APPS_ROOT" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null || true)

          echo "‚úÖ All app names are valid."

      - name: Detect changed environment folders
        id: changed_envs
        run: |
          set -e
          BASE_REF="${{ github.base_ref }}"
          echo "Comparing against base branch: $BASE_REF"

          # Fetch base ref
          git fetch origin "$BASE_REF":base_branch

          # Find changed env dirs (e.g., k8s/apps/my-app/dev)
          CHANGED_ENV_DIRS=$(git diff --name-only base_branch HEAD | \
            grep -E '^k8s/apps/[^/]+/(dev|staging|prod|dr)/' | \
            sed -E 's|^([^/]+/[^/]+/[^/]+/[^/]+).*|\1|' | sort -u)

          if [ -z "$CHANGED_ENV_DIRS" ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No environment folders changed."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_dirs<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CHANGED_ENV_DIRS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Run kustomize diff for changed environments
        if: steps.changed_envs.outputs.no_changes == 'false'
        run: |
          set -e
          BASE_REF="${{ github.base_ref }}"
          CHANGED_DIRS="${{ steps.changed_envs.outputs.changed_dirs }}"

          echo "üîÑ Detected changed environments:"
          echo "$CHANGED_DIRS"

          HAS_DIFF=false
          while IFS= read -r env_dir; do
            [ -z "$env_dir" ] && continue
            kust_file="$env_dir/kustomization.yaml"
            if [ ! -f "$kust_file" ]; then
              echo "‚ö†Ô∏è Skipping $env_dir (no kustomization.yaml)"
              continue
            fi

            echo "üìÑ Processing $env_dir..."

            # Render current (HEAD)
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/current.yaml

            # Render base branch
            git checkout base_branch --quiet
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/base.yaml
            git checkout -f HEAD --quiet

            if ! diff -u /tmp/base.yaml /tmp/current.yaml > /tmp/diff.txt; then
              echo "üî∂ DIFF in $env_dir:"
              cat /tmp/diff.txt
              HAS_DIFF=true
            else
              echo "‚úÖ No diff in $env_dir"
            fi
          done <<< "$CHANGED_DIRS"

          if [ "$HAS_DIFF" = true ]; then
            echo "‚ö†Ô∏è One or more environments have rendered manifest changes."
            echo "Review the diffs above to ensure they are intentional."
            # Note: We don't fail here‚Äîjust inform. Change to 'exit 1' if you want to block merges.
          fi