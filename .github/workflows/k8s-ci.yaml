name: Validate Kubernetes Manifests
on:
  pull_request:
    branches:
      - main
    paths:
      - k8s/apps/**
jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: alpine/k8s:1.31.7 # includes kubectl, helm, yq, git, bash
    steps:
      - name: Checkout code (current PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for full history & base branch comparison
      - name: Install colordiff
        run: apk add --no-cache colordiff
      - name: Set up variables
        id: vars
        run: |
          echo "base_ref=${{ github.base_ref }}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
      - name: Validate YAML formatting and app names
        shell: bash
        run: "set -e\n\nK8S_APPS_ROOT=\"k8s/apps\"\n\n# --- 1. YAML Formatting Check ---\necho \"\U0001F50D Checking YAML formatting...\"\nformatted_files=()\nwhile IFS= read -r -d '' file; do\n  if ! yq eval '.' \"$file\" > /tmp/formatted.yaml 2>/dev/null; then\n    echo \"‚ùå Invalid YAML syntax in $file\"\n    exit 1\n  fi\n  if ! cmp -s \"$file\" /tmp/formatted.yaml; then\n    formatted_files+=(\"$file\")\n  fi\ndone < <(find . -path \"./$K8S_APPS_ROOT/*/*/*.yaml\" -print0 2>/dev/null || true)\n\nif [ ${#formatted_files[@]} -gt 0 ]; then\n  echo \"‚ùå The following files need reformatting:\"\n  printf '  %s\\n' \"${formatted_files[@]}\"\n  echo \"\"\n  echo \"\U0001F4A1 Fix with: yq eval '.' -i <file>\"\n  exit 1\nelse\n  echo \"‚úÖ All YAML files are correctly formatted.\"\nfi\n\n# --- 2. App Name Validation ---\necho \"\U0001F50D Validating app name format...\"\nwhile IFS= read -r -d '' app_dir; do\n  app_name=$(basename \"$app_dir\")\n  if [[ ! \"$app_name\" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then\n    echo \"‚ùå Invalid app name: '$app_name'\"\n    echo \"   ‚Üí Must contain only lowercase letters, digits, and dashes (e.g., my-app-v1).\"\n    exit 1\n  fi\ndone < <(find \"./$K8S_APPS_ROOT\" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null || true)\n\necho \"‚úÖ All app names are valid.\"\n"
      - name: Detect changed environment folders (with kustomization.yaml)
        id: changed_envs
        shell: bash
        run: |
          set -e
          BASE_REF="${{ github.base_ref }}"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch origin "$BASE_REF":base_branch

          # Get all unique env-like dirs from changed files
          candidate_dirs=$(git diff --name-only base_branch HEAD | \
            grep -E '^k8s/apps/[^/]+/(dev|staging|prod|dr)/' | \
            sed -E 's|^([^/]+/[^/]+/[^/]+/[^/]+).*|\1|' | sort -u)

          valid_dirs=()
          while IFS= read -r dir; do
            if [ -n "$dir" ] && [ -f "$dir/kustomization.yaml" ]; then
              valid_dirs+=("$dir")
            fi
          done <<< "$candidate_dirs"

          if [ ${#valid_dirs[@]} -eq 0 ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No valid environment folders (with kustomization.yaml) changed."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_dirs<<EOF" >> "$GITHUB_OUTPUT"
            printf '%s\n' "${valid_dirs[@]}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi
      - name: Run kustomize diff for changed environments
        if: steps.changed_envs.outputs.no_changes == 'false'
        shell: bash
        run: |
          set -e
          CHANGED_DIRS="${{ steps.changed_envs.outputs.changed_dirs }}"

          echo "### üöÄ Kustomize Diff Summary" >> $GITHUB_STEP_SUMMARY
          echo "Detected changes in: \`$CHANGED_DIRS\`" >> $GITHUB_STEP_SUMMARY

          HAS_DIFF=false
          
          # Loop through each directory
          while IFS= read -r env_dir; do
            [ -z "$env_dir" ] && continue

            # Create a collapsible group in the console logs
            echo "::group::üìÑ Processing $env_dir"
            
            # Generate current manifests
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/current.yaml

            # Generate base manifests from the target branch
            git checkout base_branch --quiet
            kubectl kustomize "$env_dir" --enable-helm --load-restrictor LoadRestrictionsNone > /tmp/base.yaml
            git checkout -f HEAD --quiet

            # Run diff. We use || true because diff exits with 1 if changes are found
            DIFF_CONTENT=$(diff -u /tmp/base.yaml /tmp/current.yaml || true)

            if [ -n "$DIFF_CONTENT" ]; then
              HAS_DIFF=true
              
              # 1. Output to Console with ANSI Colors
              echo "üî∂ DIFF found in $env_dir:"
              diff --color=always -u /tmp/base.yaml /tmp/current.yaml || true

              # 2. Output to GitHub Step Summary (Markdown)
              echo "<details><summary>üî∂ <b>$env_dir</b> (Click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              echo "$DIFF_CONTENT" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ No diff in $env_dir"
              echo "‚úÖ **$env_dir**: No changes detected." >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "::endgroup::"
          done <<< "$CHANGED_DIRS"

          if [ "$HAS_DIFF" = true ]; then
            echo "‚ö†Ô∏è One or more environments have rendered manifest changes."
            # Optional: fail the check if you want to block PRs on diffs
            # exit 1 
          fi